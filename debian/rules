#!/usr/bin/make -f
export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all
DPKG_EXPORT_BUILDFLAGS = 1
include /usr/share/dpkg/buildflags.mk
#export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
#export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

# May still need this
#export BAZEL_WRKDIR = debian/tmp
export VERBOSE = yes
export DESTDIR = ${CURDIR}/debian/bazel-bootstrap

# Bypass ccache
export CCACHE_DISABLE = 1
export CCACHE_TEMPDIR = ${CURDIR}/debian/ccachetmp

# Ensure packages build with no Internet access
export http_proxy=127.0.0.1:9
export https_proxy=127.0.0.1:9

# BAZEL_CXXOPTS and BAZEL_LINKOPTS take a list of flags seperated by colon
export space = $() $()
export BAZEL_CXXOPTS = $(subst $(space),:,-std=c++0x ${CPPFLAGS} ${CXXFLAGS})
export BAZEL_LINKOPTS = $(subst $(space),:,-lstdc++ -lm ${LDFLAGS})

# Use the local JDK
export EXTRA_BAZEL_ARGS = \
	--host_javabase=@local_jdk//:jdk \
	--define=distribution=debian \
	--noremote_accept_cached \
	--verbose_failures \
	--compilation_mode dbg \
	--sandbox_debug \
	--sandbox_writable_path ~/.ccache/tmp \
	--distinct_host_configuration=false \
	--action_env=CCACHE_DISABLE \
	--action_env=CCACHE_TEMPDIR \
	--override_repository=com_google_protobuf=${CURDIR}/tools/distributions/debian/protobuf \
	--override_repository=remote_java_tools_linux=${CURDIR}/mock_repos/remote_java_tools_linux \
	--override_repository=bazel_skylib=${CURDIR}/mock_repos/bazel_skylib \
	--override_repository=io_bazel_skydoc=${CURDIR}/mock_repos/bazel_skydoc \
	--override_repository=rules_pkg=${CURDIR}/mock_repos/rules_pkg \
	--override_repository=rules_cc=${CURDIR}/mock_repos/rules_cc \
	--override_repository=rules_java=${CURDIR}/mock_repos/rules_java \
	--override_repository=rules_proto=${CURDIR}/mock_repos/rules_proto \
	--override_repository=platforms=${CURDIR}/mock_repos/platforms

# May still need this
#export EXTRA_BAZEL_ARGS=$EXTRA_BAZEL_ARGS --output_dir=debian/tmp

export PROTOC = /usr/bin/protoc
export GRPC_JAVA_PLUGIN = /usr/bin/grpc_java_plugin

%:
	dh $@ --with python3

override_dh_auto_build:
	mkdir -p ${CURDIR}/debian/ccachetmp
	./compile.sh

override_dh_auto_clean:
	dh_auto_clean
	rm -rf derived
	rm -f output
	rm -f bazel-*

override_dh_install:
	mkdir -p debian/tmp
	rm -f output/usr/share/bazel/xcode-locator
	rm -rf output/usr/share/bazel/embedded_tools/tools/jdk/nosystemjdk
	mv output/* debian/tmp
	dh_install

override_dh_installdocs:
	dh_installdocs
	mv debian/bazel-bootstrap/usr/share/bazel/embedded_tools/tools/build_defs/pkg/README.md \
		debian/bazel-bootstrap/usr/share/doc/bazel-bootstrap/README-build_defs.md
	mv debian/bazel-bootstrap/usr/share/bazel/embedded_tools/tools/config/README.md \
		debian/bazel-bootstrap/usr/share/doc/bazel-bootstrap/README-config.md

override_dh_link:
	jdupes -rl debian/bazel-bootstrap/usr
	find debian/bazel-bootstrap/usr/share/bazel/embedded_tools -type f -name \
		'*.h' -printf '%h\n' | sort -u | sed 's@debian.*embedded_tools/@@' | \
		xargs -I% mkdir -p debian/bazel-bootstrap/usr/include/bazel/%
	find debian/bazel-bootstrap/usr/share/bazel/embedded_tools -name '*.h' | \
		sed 's@debian/.*/embedded_tools/@@g' | xargs -I% ln -s \
		debian/bazel-bootstrap/usr/share/bazel/embedded_tools/% \
		debian/bazel-bootstrap/usr/include/bazel/%
	dh_link

override_dh_fixperms:
	find debian/bazel-bootstrap/usr/share -type f -print0 2>/dev/null | xargs -0r chmod a-x
	find debian/bazel-bootstrap/usr/share/doc/bazel/examples -type f \
		-not -name '*.sh' -print0 2>/dev/null | xargs -0r chmod a-x
	find debian/bazel-bootstrap/usr/share/bazel/embedded_tools/tools \
		-type f -name '*.sh*' -print0 2>/dev/null | xargs -0r chmod a+x
	chmod a+x ${DESTDIR}/usr/share/bazel/embedded_tools/tools/buildstamp/get_workspace_status
	chmod a+x ${DESTDIR}/usr/share/bazel/embedded_tools/tools/cpp/build_interface_so
	chmod a+x ${DESTDIR}/usr/share/bazel/embedded_tools/tools/cpp/linux_cc_wrapper.sh.tpl
	chmod a+x ${DESTDIR}/usr/share/bazel/embedded_tools/tools/cpp/osx_cc_wrapper.sh.tpl
	chmod a+x ${DESTDIR}/usr/share/bazel/embedded_tools/tools/objc/gcov_stub
	chmod a+x ${DESTDIR}/usr/share/bazel/embedded_tools/tools/objc/mcov_stub
	chmod a+x ${DESTDIR}/usr/share/bazel/embedded_tools/tools/objc/protobuf_support
	chmod a+x ${DESTDIR}/usr/share/bazel/embedded_tools/tools/python/pywrapper_template.txt
	dh_fixperms
